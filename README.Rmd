---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)

require(tidyverse,quietly=TRUE)
require(party,quietly=TRUE)
require(randomForestSRC,quietly=TRUE)
require(pec,quietly=TRUE)
require(survival,quietly=TRUE)
require(CoxBoost,quietly=TRUE)
require(obliqueRSF,quietly=TRUE)
require(ggthemes, quietly=TRUE)

```



# Overview

Oblique random survival forest (ORSFs) are ensembles for right-censured survival data that use linear combinations of input variables to recursively partition a set of training data. Regularized Cox proportional hazard models identify optimal linear combinations of input variables in each recursive partitioning step while building survival trees.

# Installation

You can install obliqueRSF from github with:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("bcjaeger/obliqueRSF")
```


# Usage

The `ORSF` function is the center piece of the `obliqueRSF` package 


```{r usage, echo=TRUE,fig.width=10,fig.height=6}


data("pbc",package='survival')

# event is death
# censored at time of last contact or transplant
pbc$status[pbc$status>=1]=pbc$status[pbc$status>=1]-1

# format categorical variables as factors
pbc = pbc %>% 
  dplyr::select(-id)%>%
  mutate(trt=factor(trt),
         ascites=factor(ascites),
         hepato=factor(hepato),
         spiders=factor(spiders),
         edema=factor(edema),
         stage=factor(stage,ordered=TRUE),
         time=time/365.25) 

set.seed(62689)
eval_times=1:10

orsf=ORSF(data=pbc,ntree=300,eval_times=eval_times,verbose=F)


# Variable dependence plot
vdplot(object=orsf$oob_preds[,5], xvar='bili', xlab='Bilirubin levels',
       times=eval_times[5], data=orsf$imputed_data, xvar_units = 'mg/dl')

vdplot(object=orsf$oob_preds, xvar='sex', xlab=c("male","female"),
       times=eval_times, data=orsf$imputed_data, fvar='hepato')

vdplot(object=orsf$oob_preds, xvar='trt', xlab=c("placebo","treatment"),
       times=eval_times, data=orsf$imputed, fvar='edema')

nboots=50

```

# Performance

`orsf` objects take a long time to grow, but they usually provide excellent predictions. Below we use the `pec` package to compare the integrated Brier scores over `r nboots` replications of bootstrap cross validation using the complete cases in the `pbc` data set.

```{r performance}

# it takes a bit more code to incorporate imputation 
# into bootstrap cross-validation. However, results
# are similar using only the complete observations,
# so that's what we will use here

pbc_cmp=na.omit(pbc)

ntree=300
nsize=20

mdls=list(
  orsf=ORSF(data=pbc_cmp, ntree=ntree, use.cv = FALSE, 
            min_obs_to_split_node = nsize, verbose=FALSE),
  rsf =rfsrc(Surv(time,status)~.,data=pbc_cmp,
             ntree=ntree,nodesize=nsize),
  bws = pec::selectCox(Surv(time,status)~., data=pbc_cmp),
  cboost = pec::coxboost(Hist(time,status)~.,data=pbc_cmp)
)

# for reproducibility
set.seed(32989) 

bri_score = pec::pec(mdls, data=pbc_cmp, cens.model = 'cox',
                     formula = Surv(time,status)~1, 
                     splitMethod = 'BootCv', B=nboots)

print(bri_score)


cnc_index = pec::cindex(mdls, data=pbc_cmp, cens.model = 'cox',
                        formula = Surv(time,status)~1, 
                        splitMethod = 'BootCv', B=nboots)

print(cnc_index)


```



